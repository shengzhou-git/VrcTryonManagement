AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "\u670D\u88C5\u56FE\u7247\u7BA1\u7406\u7CFB\u7EDF - Lambda \u540E\u7AEF"
Globals:
  Function:
    Runtime: nodejs18.x
    MemorySize: 512
    Timeout: 30
    Environment:
      Variables:
        S3_BUCKET_NAME:
          Ref: ImagesBucket
        SIGNED_URL_EXPIRATION: '3600'
        TZ: Asia/Tokyo
Parameters:
  Environment:
    Type: String
    Default: prod
    AllowedValues:
    - dev
    - prod
    Description: "\u90E8\u7F72\u73AF\u5883"
Resources:
  ImagesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: vrc-tryon-images-${Environment}
      CorsConfiguration:
        CorsRules:
        - AllowedOrigins:
          - '*'
          AllowedMethods:
          - GET
          - PUT
          - POST
          - DELETE
          - HEAD
          AllowedHeaders:
          - '*'
          MaxAge: 3000
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
  PFTryonUploadTool:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: PFTryonUploadTool-${Environment}
      Handler: index.handler
      CodeUri: PFTryonUploadTool
      Description: "PF Tryon - \u5904\u7406\u56FE\u7247\u4E0A\u4F20\u5230S3"
      Policies:
      - S3CrudPolicy:
          BucketName:
            Ref: ImagesBucket
      Events:
        UploadApi:
          Type: Api
          Properties:
            Path: /upload
            Method: POST
            RestApiId:
              Ref: ApiGateway
        UploadOptions:
          Type: Api
          Properties:
            Path: /upload
            Method: OPTIONS
            RestApiId:
              Ref: ApiGateway
    Metadata:
      SamResourceId: PFTryonUploadTool
  PFTryonGetListTool:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: PFTryonGetListTool-${Environment}
      Handler: index.handler
      CodeUri: PFTryonGetListTool
      Description: "PF Tryon - \u83B7\u53D6\u56FE\u7247\u5217\u8868"
      Policies:
      - S3ReadPolicy:
          BucketName:
            Ref: ImagesBucket
      Events:
        ListApi:
          Type: Api
          Properties:
            Path: /list
            Method: GET
            RestApiId:
              Ref: ApiGateway
        ListOptions:
          Type: Api
          Properties:
            Path: /list
            Method: OPTIONS
            RestApiId:
              Ref: ApiGateway
    Metadata:
      SamResourceId: PFTryonGetListTool
  PFTryonDeleteTool:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: PFTryonDeleteTool-${Environment}
      Handler: index.handler
      CodeUri: PFTryonDeleteTool
      Description: "PF Tryon - \u5220\u9664S3\u4E2D\u7684\u56FE\u7247"
      Policies:
      - S3CrudPolicy:
          BucketName:
            Ref: ImagesBucket
      Events:
        DeleteApi:
          Type: Api
          Properties:
            Path: /delete
            Method: POST
            RestApiId:
              Ref: ApiGateway
        DeleteOptions:
          Type: Api
          Properties:
            Path: /delete
            Method: OPTIONS
            RestApiId:
              Ref: ApiGateway
    Metadata:
      SamResourceId: PFTryonDeleteTool
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name:
        Fn::Sub: vrc-tryon-api-${Environment}
      StageName:
        Ref: Environment
      EndpointConfiguration:
        Type: REGIONAL
      Cors:
        AllowOrigin: '''*'''
        AllowHeaders: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
        AllowMethods: '''GET,POST,OPTIONS,DELETE'''
        MaxAge: '''3000'''
Outputs:
  ApiUrl:
    Description: "API Gateway \u7AEF\u70B9 URL"
    Value:
      Fn::Sub: https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${Environment}
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiUrl
  BucketName:
    Description: "S3 \u5B58\u50A8\u6876\u540D\u79F0"
    Value:
      Ref: ImagesBucket
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-BucketName
  PFTryonUploadToolArn:
    Description: "\u4E0A\u4F20\u51FD\u6570 ARN"
    Value:
      Fn::GetAtt:
      - PFTryonUploadTool
      - Arn
  PFTryonGetListToolArn:
    Description: "\u5217\u8868\u51FD\u6570 ARN"
    Value:
      Fn::GetAtt:
      - PFTryonGetListTool
      - Arn
  PFTryonDeleteToolArn:
    Description: "\u5220\u9664\u51FD\u6570 ARN"
    Value:
      Fn::GetAtt:
      - PFTryonDeleteTool
      - Arn
